<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
    <title>インシデント詳細・編集</title>
    <script th:inline="javascript">
        var subCategoryMap = /*[[${subCategoryMap}]]*/ {};
    </script>
</head>
<body>

<header>
    <a th:href="@{/}">IncidentApp</a>
</header>

<div class="page-title">
    <h1>インシデント詳細・編集</h1>
</div>

<!-- インシデント詳細フォーム -->
<form th:action="@{/incidents/{id}/update(id=${incident.id})}" th:method="post" th:object="${incident}">
    <div class="incident_input">
        <div class="side_form">
            <div class="form-section">
                <h3>レベル</h3>
                <select id="level" th:field="*{level}" required="required">
                    <option value="">選択してください</option>
                    <option value="0" th:selected="'0' == *{level}">0</option>
                    <option value="1" th:selected="'1' == *{level}">1</option>
                    <option value="2" th:selected="'2' == *{level}">2</option>
                    <option value="3a" th:selected="'3a' == *{level}">3a</option>
                    <option value="3b" th:selected="'3b' == *{level}">3b</option>
                    <option value="4" th:selected="'4' == *{level}">4</option>
                    <option value="5" th:selected="'5' == *{level}">5</option>
                </select><br><br>
            </div>
            <div class="form-section">
                <h3>発生状況</h3>
                <label for="date">発生日:</label>
                <input type="date" id="date" th:field="*{date}"><br><br>

                <label for="time">発生時刻:</label>
                <input type="time" id="time" th:field="*{time}"><br><br>

                <label for="place">発生場所:</label>
                <input type="text" id="place" th:field="*{place}"><br><br>
            </div>
            <div class="form-section">
                <h3>患者情報</h3>
                <label for="patientId">患者ID:</label>
                <input type="text" id="patientId" th:field="*{patientId}"><br><br>
                <label for="patientName">患者氏名:</label>
                <input type="text" id="patientName" th:field="*{patientName}"><br><br>
                <div class="age-container">
                    <label for="patientAge">年齢:</label>
                    <input type="number" id="patientAge" th:field="*{patientAge}">歳<br><br>
                </div>
            </div>
            <div class="form-section">
                <h3>報告者情報</h3>
                <label for="department">所属科:</label>
                <input type="text" id="department" th:field="*{department}"><br><br>
                <label for="job">職種:</label>
                <input type="text" id="job" th:field="*{job}"><br><br>
                <div class="service-container">
                    <label for="continuousService">勤続年数:</label>
                    <input type="text" id="continuousService" th:field="*{continuousService}">年<br><br>
                </div>
            </div>
        </div>
        <div class="main_form">
            <div class="form-section_category">
                <h3>カテゴリー</h3>
                <div class="category_form">
                    <div>
                        <label for="category1">大分類:</label>
                        <select id="category1" name="category1" th:field="*{category1}" required="required" onchange="updateSubCategories()">
                            <option value="">選択してください</option>
                            <option value="転倒・転落">転倒・転落</option>
                            <option value="外傷">外傷</option>
                            <option value="薬剤">薬剤</option>
                            <option value="食事">食事</option>
                            <option value="受付">受付</option>
                            <option value="診察">診察</option>
                            <option value="検査・処置">検査・処置</option>
                            <option value="放射線">放射線</option>
                            <option value="リハビリ">リハビリ</option>
                            <option value="機器操作">機器操作</option>
                            <option value="チューブ・カテーテル">チューブ・カテーテル</option>
                            <option value="その他">その他</option>

                        </select>
                    </div>
                    <div>
                        <label for="category2">小分類:</label>
                        <select id="category2" name="category2" th:field="*{category2}" required="required">
                            <option th:each="subCategory : ${subCategoryMap[incident.category1]}" th:value="${subCategory}" th:text="${subCategory}" th:selected="${subCategory} == ${incident.category2}"></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form_situation">
                <h2 class="column-title">状況・対応</h2>
                <textarea id="situation" th:field="*{situation}"></textarea>
            </div>

            <div class="form_cause">
                <h2 class="column-title">原因</h2>
                <textarea id="cause" th:field="*{cause}"></textarea>
            </div>
            <div class="form_suggestion">
                <div class="form_suggestion_title">
                    <h2 class="column-title">AIによる提案</h2>
                    <button type="button" onclick="generateAISuggestion()">AI提案を生成</button>
                </div>
                <textarea id="suggestion" th:field="*{suggestion}" readonly></textarea>
            </div>
            <div class="form_countermeasure">
                <h2 class="column-title">対策</h2>
                <textarea id="countermeasure" th:field="*{countermeasure}"></textarea>
            </div>
            <div class="form_submit">
                <button type="submit">更新</button>
            </div>
        </div>
    </div>
</form>

<script th:inline="javascript">
    var subCategoryMap = /*[[${subCategoryMap}]]*/ {};

    document.getElementById('category1').addEventListener('change', function () {
        var mainCategory = this.value;
        var subCategorySelect = document.getElementById('category2');
        subCategorySelect.innerHTML = '';

        if (mainCategory && subCategoryMap[mainCategory]) {
            subCategoryMap[mainCategory].forEach(function(subCategory) {
                var option = document.createElement('option');
                option.value = subCategory;
                option.textContent = subCategory;
                subCategorySelect.appendChild(option);
            });
        } else {
            var option = document.createElement('option');
            option.value = '';
            option.textContent = '選択してください';
            subCategorySelect.appendChild(option);
        }
    });

    function generateAISuggestion() {
        var causeValue = document.getElementById("cause").value;

        fetch('/generateAISuggestion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cause: causeValue })
        })
        .then(response => response.json())
        .then(data => {
            alert("AIからの提案: " + data.suggestion);
            document.getElementById("suggestion").value = data.suggestion;
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
</script>
</body>
</html>
</script>
</body>
</html>